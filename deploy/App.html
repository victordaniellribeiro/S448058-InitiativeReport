<!DOCTYPE html>
<html>
<head>
    <title>S448058-InitiativeReport</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){var t=this.getContext().getProject().ObjectID;console.log("project:",t);var e=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"filterPanel"}),a=Ext.create("Ext.panel.Panel",{layout:"hbox",align:"stretch",padding:5,itemId:"resultPanel"});this.add(e),this.add(a),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this}),this._loadCombo().then({success:function(t){var a=t;e.add(a)},scope:this})},_loadCombo:function(){var t=Ext.create("Deft.Deferred");return Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Initiative",fetch:["FormattedID","Name","ObjectID","State"],limit:1/0,filters:Rally.data.QueryFilter.and([{property:"State",operator:"!=",value:["Done"]},{property:"State",operator:"!=",value:["Measuring"]}])}).load().then({success:function(e){console.log("records:",e);var a=Ext.create("Ext.data.Store",{fields:["FormattedID","Name","ObjectID"],data:e}),r=Ext.create("Ext.form.ComboBox",{fieldLabel:"Choose Initiative",width:550,store:a,editable:!0,anyMatch:!0,queryMode:"local",displayField:"Name",triggerAction:"all",lastQuery:"",valueField:"ObjectID",tpl:Ext.create("Ext.XTemplate",'<tpl for=".">','<div class="x-boundlist-item">{FormattedID} - {Name}</div>',"</tpl>"),displayTpl:Ext.create("Ext.XTemplate",'<tpl for=".">',"{FormattedID} - {Name}","</tpl>"),listeners:{select:function(t,e){this.myMask.show(),console.log(e[0].data.ObjectID),this._loadStories(e[0].data.ObjectID)},scope:this}});t.resolve(r)},scope:this}),t.promise},_loadStories:function(t){Ext.create("Rally.data.WsapiDataStore",{model:"HierarchicalRequirement",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","ScheduleState","PlanEstimate","PortfolioItem","Parent"],filters:Rally.data.QueryFilter.or([{property:"PortfolioItem.Parent.ObjectID",value:t},{property:"Parent.ObjectID",value:t}]),limit:1/0}).load().then({success:function(t){console.log("records:",t),this._createPieChart(t)},scope:this})},_loadFeatures:function(t){var e=Ext.create("Deft.Deferred");return console.log("looking for incomplete stories parents:",t),Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Feature",context:{projectScopeUp:!1,projectScopeDown:!0,project:null},fetch:["FormattedID","Name","ObjectID","State","Project","PreliminaryEstimateValue","LeafStoryCount","AcceptedLeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryPlanEstimateTotal"],filters:[{property:"ObjectID",operator:"in",value:t}],limit:1/0}).load().then({success:function(t){console.log("records:",t),e.resolve(t)},scope:this}),e.promise},_generatePieChartData:function(t){var e=0,a=0,r=0,o=0,n=0,l=0,i=0,s=0,c=0,d=0,u=0,p=0,m=0,h=[];return Ext.Array.each(t,function(t){switch(m+=t.get("PlanEstimate"),1,t.get("ScheduleState")){case"Unelaborated":e+=1,i+=t.get("PlanEstimate");break;case"Defined":a+=1,s+=t.get("PlanEstimate");break;case"In-Progress":r+=1,c+=t.get("PlanEstimate");break;case"Completed":o+=1,d+=t.get("PlanEstimate");break;case"Accepted":n+=1,u+=t.get("PlanEstimate");break;case"Ready to Ship":l+=1,p+=t.get("PlanEstimate")}}),e>0&&h.push({state:"Unelaborated",count:e,planEstimate:i,percPlanned:Math.round(i/m*100)+"%"}),a>0&&h.push({state:"Defined",count:a,planEstimate:s,percPlanned:Math.round(s/m*100)+"%"}),r>0&&h.push({state:"In-Progress",count:r,planEstimate:c,percPlanned:Math.round(c/m*100)+"%"}),o>0&&h.push({state:"Completed",count:o,planEstimate:d,percPlanned:Math.round(d/m*100)+"%"}),n>0&&h.push({state:"Accepted",count:n,planEstimate:u,percPlanned:Math.round(u/m*100)+"%"}),l>0&&h.push({state:"Ready to Ship",count:l,planEstimate:p,percPlanned:Math.round(p/m*100)+"%"}),h},_generateSummaryData:function(t){var e=0,a=0,r=this._generatePieChartData(t);return Ext.Array.each(t,function(t){a+=t.get("PlanEstimate"),e+=1}),r.push({state:"Total",count:e,planEstimate:a}),r},_getFeatureIdsOfIncompleteStories:function(t){var e=[];return Ext.Array.each(t,function(t){var a=t.get("ScheduleState"),r=null!=t.get("Parent")?t.get("Parent"):t.get("PortfolioItem").ObjectID;"Accepted"!=a&&"Ready to Ship"!=a&&(console.log("In progress story: ",r,t),Ext.Array.contains(e,r)||e.push(r))}),e},_createFeatureSummaryReport:function(t){var e=this._getFeatureIdsOfIncompleteStories(t),a=this._loadFeatures(e);Deft.Promise.all([a]).then({success:function(t){console.log("promises:",t);var e=[];Ext.Array.each(t[0],function(t){e.push({Feature:t.get("FormattedID")+" - "+t.get("Name"),Project:t.get("Project").Name,LeafStoryCount:t.get("LeafStoryCount"),PreliminaryEstimateValue:t.get("PreliminaryEstimateValue")})}),this._createFeatureSummaryPanel(e)},scope:this})},_createPieChart:function(t){this.down("#resultPanel").removeAll(!0);var e=Ext.create("Ext.data.JsonStore",{fields:["state","count","planEstimate"]});e.loadData(this._generatePieChartData(t)),console.log("data",e);var a=Ext.create("Ext.chart.Chart",{xtype:"chart",animate:!0,store:e,shadow:!0,legend:{position:"right"},insetPadding:60,theme:"Base:gradients",series:[{type:"pie",angleField:"planEstimate",showInLegend:!0,donut:!1,tips:{trackMouse:!0,width:180,height:28,renderer:function(t,a){var r=0;e.each(function(t){r+=t.get("planEstimate")}),this.setTitle(Math.round(t.get("planEstimate")/r*100)+"%\n Plan Estimate: "+t.get("planEstimate"))}},highlight:{segment:{margin:20}},label:{field:"state",display:"rotate",contrast:!0,font:"18px Arial"}}]}),r=Ext.create("Ext.panel.Panel",{width:800,height:500,title:"Stories by ScheduleState",layout:"fit",items:a});this.down("#resultPanel").add(r),this._createSummaryReport(t),this._createFeatureSummaryReport(t)},_createSummaryReport:function(t){var e=Ext.create("Ext.data.JsonStore",{fields:["state","count","planEstimate","percPlanned"]});e.loadData(this._generateSummaryData(t));var a=Ext.create("Ext.panel.Panel",{layout:"vbox",align:"stretch",padding:5,itemId:"summaryPanel"}),r=Ext.create("Ext.grid.Panel",{store:e,height:245,width:450,title:"Stories Count",viewConfig:{stripeRows:!0,enableTextSelection:!0},columns:[{text:"State",flex:1,sortable:!1,dataIndex:"state"},{text:"Count",width:60,sortable:!1,dataIndex:"count"},{text:"Plan Estimate",width:100,sortable:!1,dataIndex:"planEstimate"},{text:"% Planned",width:90,sortable:!1,dataIndex:"percPlanned"}]});a.add(r),this.down("#resultPanel").add(a)},_createFeatureSummaryPanel:function(t){var e=Ext.create("Ext.data.JsonStore",{fields:["Feature","Project","LeafStoryCount","PreliminaryEstimateValue"]});e.loadData(t);var a=Ext.create("Ext.grid.Panel",{title:"Features In-Progress",height:245,width:650,viewConfig:{stripeRows:!0,enableTextSelection:!0},store:e,columns:[{text:"Feature",flex:2,sortable:!1,dataIndex:"Feature"},{text:"Project",flex:1,sortable:!1,dataIndex:"Project"},{text:"Count",width:60,sortable:!1,dataIndex:"LeafStoryCount"},{text:"Preliminary Estimate",width:120,sortable:!1,dataIndex:"PreliminaryEstimateValue"}]});this.down("#summaryPanel").add(a),this.myMask.hide()}});

            Rally.launchApp('CustomApp', {
                name:"S448058-InitiativeReport",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
